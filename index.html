<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Echo Protocols</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="apple-mobile-web-app-title" content="Echo">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --background-color: #FFFFFF;
            --text-color: #000000;
            --border-color: #000000;
            --button-bg-color: #f0f0f0;
            --button-active-bg: #dcdcdc;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); }
        .page { display: none; width: 100%; height: 100%; padding: 20px; overflow-y: auto; flex-direction: column; }
        .page.active { display: flex; }
        .main-menu { display: flex; flex-direction: column; gap: 15px; justify-content: center; flex-grow: 1; }
        .btn { padding: 20px; font-size: 1.2rem; text-align: center; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; background-color: var(--button-bg-color); color: var(--text-color); width: 100%; -webkit-tap-highlight-color: transparent; }
        .btn:active { background-color: var(--button-active-bg); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .header h1 { font-size: 1.5rem; text-align: right; }
        .back-btn { font-size: 1.1rem; padding: 8px 15px; cursor: pointer; border: 1px solid var(--border-color); border-radius: 5px; background-color: transparent; color: var(--text-color); white-space: nowrap; }
        .content { font-size: 1rem; line-height: 1.6; flex-grow: 1; }
        .content p { margin-bottom: 0.5em; }
        .content h2 { margin-top: 2em; margin-bottom: 1em; font-size: 1.3rem; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        .content h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.1rem; font-weight: bold; }
        .content details { margin-bottom: 1em; padding-left: 10px; border-left: 2px solid #e0e0e0; }
        .content .indented-details { margin-left: 20px; }
        .content summary { cursor: pointer; }
        .content details > div { padding-left: 20px; margin-top: 10px; }
        .content table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        .content th, .content td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .content th { background-color: #f2f2f2; }
        .content img { max-width: 100%; height: auto; margin: 1em 0; }
        .tappable-ref { cursor: pointer; color: #0056b3; text-decoration: underline; text-decoration-style: dotted; }
        .hidden-ref { display: none; font-style: italic; color: #555; background-color: #f0f0f0; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }
        .hidden { display: none !important; }
        .disclaimer { font-size: 0.75rem; color: #6c757d; text-align: center; margin-bottom: 30px; padding: 0 20px; flex-shrink: 0; }

        /* --- REPORT FORM STYLES --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; }
        .form-section { margin-bottom: 25px; border-top: 1px solid #eee; padding-top: 15px; }
        .form-section h3 { margin-bottom: 15px; font-size: 1rem; text-transform: uppercase; color: #333; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .input-group input[readonly] { background-color: #f9f9f9; color: #888; border: 1px dashed #ccc; }
        .rwma-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; align-items: center; text-align: left; }
        .check-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .check-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; background: #f4f4f4; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="home-page" class="page active">
        <p class="disclaimer">These protocols are not endorsed by any professional bodies. Use at your own risk.</p>
        <div class="main-menu">
            <div class="btn" id="pah-trigger" style="border-color: #d93025; color: #d93025;">POCUS PAH Report Form</div>
            <div class="btn" data-page="iheartscan">iHeartScan</div>
            <div class="btn" data-page="standard-echo">Standard Echocardiography Protocol</div>
            <div class="btn" data-page="pocus">POCUS</div>
            <div class="btn" data-page="limited-lv">Limited LV Assessment</div>
            <div class="btn" data-page="limited-rv">Limited RV Assessment</div>
            <div class="btn" data-page="limited-valve">Limited Scan Protocol for Mitral and Aortic Valves</div>
            <div class="btn" data-page="pathology-menu">By Pathology (Minimal Scan)</div>
        </div>
    </div>

    <div id="warning-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:#d93025; margin-bottom:15px;">⚠️ WARNING</h2>
            <p style="margin-bottom:20px;">This is an unsecure form. Do not enter sensitive patient details (Names, MRNs, or full DOBs).</p>
            <div style="display:flex; gap:10px;">
                <div class="btn" id="cancel-warn" style="font-size:1rem; padding:12px;">Cancel</div>
                <div class="btn" id="accept-warn" style="font-size:1rem; padding:12px; background:black; color:white;">Acknowledged</div>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal">
        <div class="modal-content">
            <h3>Complete Report</h3>
            <p style="margin: 15px 0;">Enter email to receive summary.</p>
            <input type="email" id="target-email" placeholder="email@hospital.com" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:6px; margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <div class="btn" id="cancel-email" style="font-size:1rem; padding:12px;">Back</div>
                <div class="btn" id="finish-report" style="font-size:1rem; padding:12px; background:#28a745; color:white;">Generate PDF</div>
            </div>
        </div>
    </div>

    <div id="pah-report-page" class="page">
        <div class="header">
            <button class="back-btn">&lt; Back</button>
            <h1>PAH Report Form</h1>
        </div>
        <form id="pah-form">
            <div class="form-section">
                <h3>Patient Info (Locked)</h3>
                <div class="input-group"><label>Name</label><input type="text" readonly placeholder="LOCKED"></div>
                <div class="input-group"><label>MRN</label><input type="text" readonly placeholder="LOCKED"></div>
                <div class="input-group"><label>DOB</label><input type="text" readonly placeholder="LOCKED"></div>
                <div class="input-group"><label>Operator</label><input type="text" name="operator"></div>
                <div class="input-group"><label>Exam Date</label><input type="date" name="date"></div>
            </div>

            <div class="form-section">
                <h3>Context</h3>
                <div class="input-group"><label>Medical History / Hemodynamic Therapy</label><textarea name="history" rows="2"></textarea></div>
                <div class="check-grid">
                    <label class="check-item"><input type="checkbox" name="cq" value="Hemodynamic instability"> Instability</label>
                    <label class="check-item"><input type="checkbox" name="cq" value="LV Evaluation"> LV Eval</label>
                    <label class="check-item"><input type="checkbox" name="cq" value="RV Evaluation"> RV Eval</label>
                    <label class="check-item"><input type="checkbox" name="cq" value="Pulmonary Pressure"> Pulmonary Pressure</label>
                    <label class="check-item"><input type="checkbox" name="cq" value="Volume Status"> Volume Status</label>
                    <label class="check-item"><input type="checkbox" name="cq" value="Valvulopathy"> Valvulopathy</label>
                    <label class="check-item"><input type="checkbox" name="cq" value="Cardiac Arrest"> Arrest</label>
                </div>
                <div class="input-group" style="margin-top:15px;">
                    <label>Ventilation</label>
                    <select name="ventilation"><option value="Spontaneous">Spontaneous</option><option value="Mechanical Ventilation">Mechanical Ventilation</option></select>
                </div>
                <div class="input-group">
                    <label>Image Quality</label>
                    <select name="img_quality"><option value="Excellent">Excellent</option><option value="Satisfactory">Satisfactory</option><option value="Poor">Poor</option><option value="Very Poor">Very Poor</option></select>
                </div>
            </div>

            <div class="form-section">
                <h3>PLAX / PSAX Measurements</h3>
                <div class="input-group"><label>Pericardial Effusion (20cm)</label><select name="plax_eff"><option value="None">None</option><option value="<0.5cm"><0.5cm</option><option value="0.5-2cm">0.5-2cm</option><option value=">2cm">>2cm</option></select></div>
                <div class="input-group"><label>LV End-Diastolic Diameter</label><select name="lv_edd"><option value="35-55mm (Normal)">35-55mm (Normal)</option><option value="<35mm (Small)"><35mm (Small)</option><option value=">55mm (Dilated)">>55mm (Dilated)</option></select></div>
                <div class="input-group"><label>RV Septal Flattening</label><select name="septum"><option value="None">None</option><option value="During Systole">During Systole</option><option value="During Diastole">During Diastole</option><option value="Fixed">Fixed</option></select></div>
                <div class="input-group"><label>TR Jet Peak Velocity (m/s)</label><input type="number" step="0.1" name="tr_vel"></div>
                <div class="input-group"><label>RVSP (4V² + RAp)</label><input type="number" name="rvsp"></div>
            </div>

            <div class="form-section">
                <h3>17-Segment RWMA</h3>
                <div id="rwma-grid"></div>
            </div>

            <div class="form-section">
                <h3>Apical / Quantification</h3>
                <div class="input-group"><label>TAPSE (mm)</label><input type="number" name="tapse" step="0.1"></div>
                <div class="input-group"><label>RV FAC (%)</label><input type="number" name="rv_fac"></div>
                <div class="input-group"><label>LV Ejection Fraction (%)</label><select name="ef"><option value=">50% (Normal)">>50% (Normal)</option><option value="40-50% (Mildly Reduced)">40-50% (Mildly Reduced)</option><option value="30-40% (Moderately Reduced)">30-40% (Moderately Reduced)</option><option value="<30% (Severely Reduced)"><30% (Severely Reduced)</option></select></div>
                <div class="input-group"><label>IVC Diameter (cm)</label><select name="ivc_d"><option value="<2.1cm"><2.1cm</option><option value=">2.1cm">>2.1cm</option></select></div>
                <div class="input-group"><label>IVC Sniff Variation</label><select name="ivc_v"><option value=">50% sniff variation">>50% sniff variation</option><option value="<50% sniff variation"><50% sniff variation</option></select></div>
            </div>

            <div class="form-section">
                <h3>Summary Findings</h3>
                <div class="input-group"><label>Final Haemodynamic State</label>
                    <div class="check-grid">
                        <label class="check-item"><input type="checkbox" name="haemo" value="Hypovolaemia"> Hypovolaemia</label>
                        <label class="check-item"><input type="checkbox" name="haemo" value="LV systolic failure"> LV Failure</label>
                        <label class="check-item"><input type="checkbox" name="haemo" value="RV systolic failure"> RV Failure</label>
                        <label class="check-item"><input type="checkbox" name="haemo" value="Vasoplegia"> Vasoplegia</label>
                        <label class="check-item"><input type="checkbox" name="haemo" value="Obstructive shock"> Obstructive Shock</label>
                        <label class="check-item"><input type="checkbox" name="haemo" value="LVOTO/SAM"> LVOTO/SAM</label>
                    </div>
                </div>
            </div>

            <div class="btn" id="btn-complete" style="background:#28a745; color:white; font-weight:bold;">COMPLETE REPORT</div>
        </form>
        <div style="height:60px;"></div>
    </div>

    <div id="pathology-menu-page" class="page">
        <div class="header">
            <button class="back-btn">&lt; Back</button>
            <h1 id="pathology-menu-title"></h1>
        </div>
        <div id="pathology-menu-content" class="content"></div>
    </div>

    <div id="content-page" class="page">
        <div class="header">
            <button class="back-btn">&lt; Back</button>
            <h1 id="content-page-title"></h1>
        </div>
        <div id="content-page-content" class="content"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const segments = ["Basal Anterior (LAD)", "Basal Anteroseptal (LAD)", "Basal Inferoseptal (RCA)", "Basal Inferior (RCA)", "Basal Inferolateral (LCX)", "Basal Anterolateral (LCX)", "Mid Anterior (LAD)", "Mid Anteroseptal (LAD)", "Mid Inferoseptal (RCA)", "Mid Inferior (RCA)", "Mid Inferolateral (LCX)", "Mid Anterolateral (LCX)", "Apical Anterior (LAD)", "Apical Septal (LAD)", "Apical Inferior (RCA)", "Apical Lateral (LCX)", "Apex"];
        let currentPageId = 'home-page';
        const contentCache = {};

        const init = () => {
            setupEventListeners();
            registerServiceWorker();
            const grid = document.getElementById('rwma-grid');
            if(grid) segments.forEach((s, i) => grid.innerHTML += `<div class="rwma-row"><span>${s}</span><select name="seg_${i}"><option value="Normal">Normal</option><option value="Hypokinetic">Hypokinetic</option><option value="Akinetic">Akinetic</option><option value="Dyskinetic">Dyskinetic</option></select></div>`);
            history.replaceState({ page: 'home-page' }, '', '#home');
        };

        const parseMarkdown = (text) => {
            const lines = text.split('\n');
            let html = '';
            let isTable = false;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('<')) { html += line; continue; }
                if (trimmedLine.includes('|')) {
                    if (!isTable) {
                        html += '<table>';
                        if (lines[i + 1] && lines[i + 1].includes('---')) {
                            html += '<thead><tr>';
                            trimmedLine.split('|').forEach(cell => { if (cell.trim()) html += `<th>${cell.trim()}</th>`; });
                            html += '</tr></thead><tbody>';
                            i++; isTable = true;
                        } else {
                            html += '<tbody><tr>';
                            trimmedLine.split('|').forEach(cell => { if (cell.trim()) html += `<td>${cell.trim()}</td>`; });
                            html += '</tr>'; isTable = true;
                        }
                    } else {
                        html += '<tr>';
                        trimmedLine.split('|').forEach(cell => { if (cell.trim()) html += `<td>${cell.trim()}</td>`; });
                        html += '</tr>';
                    }
                    continue;
                }
                if (isTable) { html += '</tbody></table>'; isTable = false; }
                if (trimmedLine.startsWith('## ')) html += `<h3>${trimmedLine.substring(3)}</h3>`;
                else if (trimmedLine.startsWith('# ')) html += `<h2>${trimmedLine.substring(2)}</h2>`;
                else if (trimmedLine.startsWith('* ')) {
                    const indent = line.search(/\S/);
                    html += `<p style="margin-left: ${indent * 10}px;">&bull; ${trimmedLine.substring(1).replace(/\*(.*?)\*/g, '<em>$1</em>')}</p>`;
                }
                else if (trimmedLine.length > 0) {
                    html += `<p>${trimmedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')}</p>`;
                }
            }
            if (isTable) { html += '</tbody></table>'; }
            return html;
        };

        const loadContent = async (pageId) => {
            if (contentCache[pageId]) return contentCache[pageId];
            try {
                const response = await fetch(`${pageId}.txt?v=${new Date().getTime()}`);
                const text = await response.text();
                const lines = text.split('\n');
                const title = lines.shift();
                const body = lines.join('\n');
                const parsedContent = { title, body: parseMarkdown(body) };
                contentCache[pageId] = parsedContent;
                return parsedContent;
            } catch (error) { return { title: 'Error', body: '<p>Could not load content.</p>' }; }
        };

        const renderPage = async (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            currentPageId = pageId;
            if (pageId === 'home-page') { document.getElementById('home-page').classList.add('active'); return; }
            if (pageId === 'pah-report') { document.getElementById('pah-report-page').classList.add('active'); return; }
            const isSubMenu = pageId === 'pathology-menu';
            const pageToShow = isSubMenu ? document.getElementById('pathology-menu-page') : document.getElementById('content-page');
            const titleElement = isSubMenu ? document.getElementById('pathology-menu-title') : document.getElementById('content-page-title');
            const contentElement = isSubMenu ? document.getElementById('pathology-menu-content') : document.getElementById('content-page-content');
            pageToShow.classList.add('active');
            const content = await loadContent(pageId);
            titleElement.textContent = content.title;
            contentElement.innerHTML = content.body;
        };

        const setupEventListeners = () => {
            document.body.addEventListener('click', function(event) {
                const target = event.target.closest('.btn[data-page]');
                if (target) { history.pushState({ page: target.dataset.page }, '', `#${target.dataset.page}`); renderPage(target.dataset.page); return; }
                
                if (event.target.id === 'pah-trigger') document.getElementById('warning-modal').style.display = 'flex';
                if (event.target.id === 'cancel-warn') document.getElementById('warning-modal').style.display = 'none';
                if (event.target.id === 'accept-warn') {
                    document.getElementById('warning-modal').style.display = 'none';
                    history.pushState({ page: 'pah-report' }, '', '#report');
                    renderPage('pah-report');
                }
                if (event.target.id === 'btn-complete') document.getElementById('email-modal').style.display = 'flex';
                if (event.target.id === 'cancel-email') document.getElementById('email-modal').style.display = 'none';
                if (event.target.id === 'finish-report') generatePDF();
                
                if (event.target.closest('.back-btn')) history.back();
            });
        };

        const generatePDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const form = document.getElementById('pah-form');
            const data = new FormData(form);
            const email = document.getElementById('target-email').value;

            doc.setFontSize(16);
            doc.text("PAH POCUS CARDIAC ECHO REPORT", 20, 20);
            doc.setFontSize(10);
            doc.text(`Operator: ${data.get('operator')}`, 20, 30);
            doc.text(`Date: ${data.get('date')}`, 20, 35);
            doc.line(20, 38, 190, 38);

            doc.setFontSize(12);
            doc.text("CONTEXT", 20, 45);
            doc.setFontSize(10);
            const questions = Array.from(document.querySelectorAll('input[name="cq"]:checked')).map(cb => cb.value).join(', ');
            doc.text(`Clinical Question: ${questions}`, 20, 52);
            doc.text(`Ventilation: ${data.get('ventilation')}`, 20, 57);
            doc.text(`Image Quality: ${data.get('img_quality')}`, 20, 62);
            
            doc.setFontSize(12);
            doc.text("SCAN FINDINGS", 20, 72);
            doc.setFontSize(10);
            doc.text(`Pericardial Effusion: ${data.get('plax_eff')}`, 20, 79);
            doc.text(`LV EDD: ${data.get('lv_edd')}`, 20, 84);
            doc.text(`RV Septum: ${data.get('septum')}`, 20, 89);
            doc.text(`RVSP: ${data.get('rvsp')} mmHg (TR Vel: ${data.get('tr_vel')} m/s)`, 20, 94);
            doc.text(`TAPSE: ${data.get('tapse')} mm`, 20, 99);
            doc.text(`RV FAC: ${data.get('rv_fac')}%`, 20, 104);
            doc.text(`LV EF: ${data.get('ef')}`, 20, 109);
            doc.text(`IVC: ${data.get('ivc_d')} with ${data.get('ivc_v')}`, 20, 114);

            doc.setFontSize(12);
            doc.text("RWMA (NON-NORMAL SEGMENTS)", 20, 124);
            doc.setFontSize(9);
            let y = 131;
            segments.forEach((seg, i) => {
                const motion = data.get(`seg_${i}`);
                if (motion !== "Normal") {
                    doc.text(`${seg}: ${motion}`, 25, y);
                    y += 5;
                }
            });
            if (y === 131) doc.text("All 17 segments are normal.", 25, y);

            doc.setFontSize(12);
            doc.text("SUMMARY", 20, y + 15);
            doc.setFontSize(10);
            const states = Array.from(document.querySelectorAll('input[name="haemo"]:checked')).map(cb => cb.value).join(', ');
            doc.text(`Haemodynamic State: ${states}`, 20, y + 22);

            doc.save(`Echo_Report_${data.get('date') || 'export'}.pdf`);
            alert("Report Generated. Attach PDF manually to: " + email);
            document.getElementById('email-modal').style.display = 'none';
            history.back();
        };

        window.onpopstate = (event) => renderPage(event.state?.page || 'home-page');
        const registerServiceWorker = () => { /* SW Logic Untouched */ };
        init();
    });
    </script>
</body>
</html>
